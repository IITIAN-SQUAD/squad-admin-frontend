# Set Password Flow Documentation

## Overview
When a Super Admin adds a new admin, the new admin receives an email with a link to set their password. This is the same flow used for password reset.

## Page Path
**Set Password Screen**: `/set-password`

**File Locations**:
- Page: `/app/set-password/page.tsx`
- Component: `/src/components/auth/SetPasswordContent.tsx`

## Flow Diagram

### 1. Super Admin Invites New Admin
```
Super Admin → Admin Management → Invite Admin
↓
Enter: Email + Role (no username needed)
↓
Backend generates unique token
↓
Email sent to: admin@example.com
```

### 2. Email Content
```
Subject: Set Your Password - IITian Squad Admin

Hi,

You've been invited to join IITian Squad Admin panel.

Click the link below to set your password:
https://admin.iitian-squad.com/set-password?token=abc123xyz

This link will expire in 24 hours.

Best regards,
IITian Squad Team
```

### 3. Admin Clicks Link
```
URL: /set-password?token=abc123xyz
↓
Page loads with token in URL
↓
Backend verifies token
↓
Shows email address
↓
Admin sets password
↓
Success → Redirect to /login
```

## Set Password Screen UI

### Components
1. **Header**
   - Yellow circle with lightning icon
   - Title: "Set Your Password"
   - Description: "Welcome, {email}" + "Create a secure password"

2. **Form Fields**
   - Password (with show/hide toggle)
   - Confirm Password (with show/hide toggle)
   - Password requirements shown below

3. **Password Requirements**
   - At least 8 characters
   - One uppercase letter
   - One lowercase letter
   - One number
   - One special character

4. **Submit Button**
   - "Set Password" (yellow button)
   - Shows "Setting Password..." when submitting

5. **Success State**
   - Green success message
   - "Password set successfully! Redirecting to login..."
   - Auto-redirects after 3 seconds

## URL Structure

### Set Password Link
```
https://admin.iitian-squad.com/set-password?token={unique-token}
```

### Token Parameter
- **Required**: Yes
- **Format**: String (generated by backend)
- **Purpose**: Identifies the admin and validates the invitation
- **Expiration**: 24 hours (configurable)

## Backend Integration Points

### 1. Generate Invitation
**Endpoint**: `POST /api/admin/invite`

**Request**:
```json
{
  "email": "newadmin@example.com",
  "roleId": "role-id-here"
}
```

**Response**:
```json
{
  "success": true,
  "message": "Invitation sent",
  "inviteId": "invite-123",
  "token": "unique-token-abc123",
  "expiresAt": "2024-12-03T12:00:00Z"
}
```

**Backend Actions**:
1. Create admin record (status: pending)
2. Generate unique token
3. Store token with expiration
4. Send email with set-password link
5. Return success response

### 2. Verify Token
**Endpoint**: `GET /api/auth/verify-invite?token={token}`

**Response**:
```json
{
  "valid": true,
  "email": "newadmin@example.com",
  "name": "New Admin",
  "role": "Content Editor"
}
```

**Backend Actions**:
1. Validate token exists
2. Check if token expired
3. Return admin details
4. Return error if invalid/expired

### 3. Set Password
**Endpoint**: `POST /api/auth/set-password`

**Request**:
```json
{
  "token": "unique-token-abc123",
  "password": "SecurePass123!",
  "confirmPassword": "SecurePass123!"
}
```

**Response**:
```json
{
  "success": true,
  "message": "Password set successfully"
}
```

**Backend Actions**:
1. Validate token
2. Validate password requirements
3. Hash password
4. Update admin record
5. Mark token as used
6. Update admin status to active
7. Send confirmation email (optional)

## Database Schema

### Admin Table
```sql
CREATE TABLE admins (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255),
  role_id UUID REFERENCES roles(id),
  status VARCHAR(50) DEFAULT 'pending', -- pending, active, inactive
  password_set BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### Invite Tokens Table
```sql
CREATE TABLE invite_tokens (
  id UUID PRIMARY KEY,
  admin_id UUID REFERENCES admins(id),
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT false,
  used_at TIMESTAMP,
  created_by UUID REFERENCES admins(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index for quick token lookup
CREATE INDEX idx_invite_token ON invite_tokens(token);
CREATE INDEX idx_invite_expires ON invite_tokens(expires_at);
```

## Security Considerations

### Current Implementation (UI Only)
- ✅ Password validation (client-side)
- ✅ Password confirmation matching
- ✅ Show/hide password toggle
- ✅ Token in URL parameter
- ⚠️ No actual backend validation (demo mode)

### Production Requirements
- [ ] **Token Security**
  - Generate cryptographically secure random tokens
  - Use UUID v4 or similar
  - Store hashed tokens in database
  
- [ ] **Token Expiration**
  - 24-hour expiration (configurable)
  - Cleanup expired tokens regularly
  - One-time use only
  
- [ ] **Password Security**
  - Hash with bcrypt (cost factor 12+)
  - Never store plain text passwords
  - Validate password strength on backend
  
- [ ] **Rate Limiting**
  - Limit password set attempts
  - Prevent brute force attacks
  - Lock account after failed attempts
  
- [ ] **Email Security**
  - Use HTTPS links only
  - Include expiration time in email
  - Add "ignore if not you" message
  
- [ ] **Audit Logging**
  - Log all invitation sends
  - Log password set attempts
  - Log token verifications
  - Track who invited whom

## Email Service Integration

### Using Nodemailer
```typescript
import nodemailer from 'nodemailer';

async function sendInviteEmail(email: string, token: string) {
  const transporter = nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: 587,
    secure: false,
    auth: {
      user: process.env.SMTP_USER,
      pass: process.env.SMTP_PASS,
    },
  });

  const setPasswordUrl = `${process.env.APP_URL}/set-password?token=${token}`;

  await transporter.sendMail({
    from: '"IITian Squad" <noreply@iitian-squad.com>',
    to: email,
    subject: 'Set Your Password - IITian Squad Admin',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Welcome to IITian Squad Admin</h2>
        <p>You've been invited to join the admin panel.</p>
        <p>Click the button below to set your password:</p>
        <a href="${setPasswordUrl}" 
           style="display: inline-block; padding: 12px 24px; background: #ffd700; 
                  color: #000; text-decoration: none; border-radius: 4px; font-weight: bold;">
          Set Password
        </a>
        <p style="margin-top: 20px; color: #666; font-size: 14px;">
          Or copy this link: <br/>
          <a href="${setPasswordUrl}">${setPasswordUrl}</a>
        </p>
        <p style="margin-top: 20px; color: #666; font-size: 12px;">
          This link will expire in 24 hours.<br/>
          If you didn't request this, please ignore this email.
        </p>
      </div>
    `,
  });
}
```

## Testing

### Manual Test Flow
1. **Generate Test Link**
   ```
   http://localhost:3001/set-password?token=test-token-123
   ```

2. **Visit Link**
   - Should see set password form
   - Should show email (or default for demo)

3. **Enter Password**
   - Password: `Test123!@#`
   - Confirm: `Test123!@#`

4. **Submit**
   - Should show success message
   - Should redirect to `/login` after 3 seconds

5. **Login**
   - Use the email and new password
   - Should be able to login

### Test Cases
- ✅ Valid token → Shows form
- ✅ No token → Shows error
- ✅ Password mismatch → Shows error
- ✅ Weak password → Shows validation error
- ✅ Success → Redirects to login
- ⏳ Expired token → Should show error (backend)
- ⏳ Used token → Should show error (backend)

## Error Handling

### Client-Side Errors
1. **No Token in URL**
   - Message: "Invalid invitation link"
   - Action: Show error alert

2. **Password Validation**
   - Too short: "Password must be at least 8 characters"
   - No uppercase: "Must contain uppercase letter"
   - No lowercase: "Must contain lowercase letter"
   - No number: "Must contain number"
   - No special char: "Must contain special character"

3. **Password Mismatch**
   - Message: "Passwords don't match"
   - Field: confirmPassword

### Backend Errors (To Implement)
1. **Invalid Token**
   - Status: 400
   - Message: "Invalid or expired invitation link"

2. **Expired Token**
   - Status: 400
   - Message: "This invitation link has expired"

3. **Used Token**
   - Status: 400
   - Message: "This invitation has already been used"

4. **Weak Password**
   - Status: 400
   - Message: "Password does not meet requirements"

## Same Flow for Password Reset

This same screen and flow is used for:
1. **New Admin Invitation** (Super Admin adds admin)
2. **Password Reset** (Admin forgets password)

The only difference is the email subject and message:

### Password Reset Email
```
Subject: Reset Your Password - IITian Squad Admin

Hi {name},

We received a request to reset your password.

Click the link below to set a new password:
https://admin.iitian-squad.com/set-password?token=xyz789

This link will expire in 24 hours.

If you didn't request this, please ignore this email.

Best regards,
IITian Squad Team
```

## Environment Variables

```env
# App URL
NEXT_PUBLIC_APP_URL=https://admin.iitian-squad.com

# Email Service
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=noreply@iitian-squad.com
SMTP_PASS=your-app-password

# Token Settings
INVITE_TOKEN_EXPIRY_HOURS=24
PASSWORD_RESET_TOKEN_EXPIRY_HOURS=1

# Security
BCRYPT_ROUNDS=12
```

## Summary

- ✅ **Screen Path**: `/set-password?token={token}`
- ✅ **UI Complete**: Password form with validation
- ✅ **Flow**: Email → Link → Set Password → Login
- ✅ **Same for**: New admin invite + Password reset
- ⏳ **Backend Needed**: Token generation, validation, email sending
- ⏳ **Security**: Token expiration, password hashing, rate limiting

The UI is ready! Backend needs to implement the API endpoints for token generation, verification, and password setting.
